<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Learning App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS to ensure a good layout on all devices */
        body {
            background-color: #f3f4f6;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        #root {
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Firebase CDNs (v11.6.1) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <script>
        // Global variables for Firebase, provided automatically by the Canvas environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Get Firebase functions from CDN
        const { initializeApp } = firebase;
        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = firebase.auth;
        const { getFirestore, collection, addDoc, onSnapshot, orderBy, query, where, deleteDoc, doc } = firebase.firestore;
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // React logic starts here
        const { useState, useEffect, useRef } = React;

        const App = () => {
            // State to manage application data and status
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [inputPhrase, setInputPhrase] = useState('');
            const [inputLanguage, setInputLanguage] = useState('en');
            const [targetLanguage, setTargetLanguage] = useState('vi');
            const [translations, setTranslations] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [modalMessage, setModalMessage] = useState('');
            const [deleteCandidate, setDeleteCandidate] = useState(null);

            // Ref for the input field to focus
            const inputRef = useRef(null);

            // Initialize Firebase Auth and listener
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        // Sign in anonymously if not logged in
                        signInAnonymously(auth).then((result) => {
                            setUserId(result.user.uid);
                        }).catch(error => console.error("Anonymous sign-in error:", error));
                    }
                    setIsAuthReady(true);
                });
                
                // Use custom token if available
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken).catch(error => console.error("Custom token sign-in error:", error));
                }

                return () => unsubscribe();
            }, []);

            // Listener for Firestore to get real-time data updates
            useEffect(() => {
                if (!db || !userId) return;

                const colRef = collection(db, `artifacts/${appId}/users/${userId}/translations`);
                // Listen for real-time data changes
                const unsubscribe = onSnapshot(colRef, (snapshot) => {
                    const newTranslations = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setTranslations(newTranslations);
                }, (error) => {
                    console.error("Error fetching data from Firestore:", error);
                });

                return () => unsubscribe();
            }, [db, userId]);

            // Function to call the translation API
            const translatePhrase = async () => {
                if (!inputPhrase.trim() || loading) return;

                setLoading(true);
                try {
                    // Payload structure to call the translation API
                    const payload = {
                        contents: [{
                            parts: [{ text: `Translate this phrase: "${inputPhrase}" from ${inputLanguage} to ${targetLanguage}` }]
                        }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                "type": "OBJECT",
                                "properties": {
                                    "translatedText": { "type": "STRING" }
                                }
                            }
                        }
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    let response;
                    for (let i = 0; i < 3; i++) { // Exponential backoff for retries
                        try {
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (response.ok) break;
                            await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                        } catch (e) {
                            await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                        }
                    }

                    if (!response || !response.ok) throw new Error('API request failed');

                    const result = await response.json();
                    const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    const parsedJson = JSON.parse(jsonString);
                    const translatedText = parsedJson?.translatedText;

                    if (translatedText) {
                        // Add the new translation to Firestore
                        const colRef = collection(db, `artifacts/${appId}/users/${userId}/translations`);
                        await addDoc(colRef, {
                            original: inputPhrase,
                            translation: translatedText,
                            timestamp: new Date()
                        });
                        setInputPhrase('');
                    } else {
                        setModalMessage("Could not translate the text. Please try again.");
                        setShowModal(true);
                    }
                } catch (error) {
                    console.error("Error translating text:", error);
                    setModalMessage("An error occurred. Please check your network connection and try again.");
                    setShowModal(true);
                } finally {
                    setLoading(false);
                }
            };

            // Function to confirm translation deletion
            const confirmDelete = (translationId) => {
                setDeleteCandidate(translationId);
                setModalMessage("Are you sure you want to delete this translation?");
                setShowModal(true);
            };

            // Function to perform the translation deletion
            const handleDelete = async () => {
                if (deleteCandidate) {
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/translations`, deleteCandidate);
                        await deleteDoc(docRef);
                    } catch (error) {
                        console.error("Error deleting translation:", error);
                        setModalMessage("Could not delete the translation. Please try again.");
                        setShowModal(true);
                    } finally {
                        setDeleteCandidate(null);
                        setShowModal(false);
                    }
                }
            };

            // Function to cancel translation deletion
            const cancelDelete = () => {
                setDeleteCandidate(null);
                setShowModal(false);
            };

            // Custom Modal Component
            const Modal = ({ message, onConfirm, onCancel, showConfirm = true }) => {
                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg p-6 max-w-sm w-full shadow-lg border border-gray-200">
                            <p className="text-gray-800 text-lg mb-4">{message}</p>
                            <div className="flex justify-end space-x-3">
                                <button
                                    onClick={onCancel}
                                    className="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors"
                                >
                                    Cancel
                                </button>
                                {showConfirm && (
                                    <button
                                        onClick={onConfirm}
                                        className="px-4 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors"
                                    >
                                        Confirm
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            // Render the UI
            return (
                <div className="bg-gray-100 min-h-screen flex flex-col items-center p-4 text-gray-800">
                    <div className="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl mt-8">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-3xl font-bold text-gray-900">Translator</h1>
                            {userId && <span className="text-sm text-gray-500 truncate">UID: {userId}</span>}
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label htmlFor="inputLang" className="block text-sm font-medium text-gray-700">Source Language</label>
                                <select
                                    id="inputLang"
                                    value={inputLanguage}
                                    onChange={(e) => setInputLanguage(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                >
                                    <option value="en">English</option>
                                    <option value="vi">Vietnamese</option>
                                    <option value="fr">French</option>
                                </select>
                            </div>
                            <div>
                                <label htmlFor="targetLang" className="block text-sm font-medium text-gray-700">Target Language</label>
                                <select
                                    id="targetLang"
                                    value={targetLanguage}
                                    onChange={(e) => setTargetLanguage(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                >
                                    <option value="vi">Vietnamese</option>
                                    <option value="en">English</option>
                                    <option value="fr">French</option>
                                </select>
                            </div>
                        </div>

                        <textarea
                            ref={inputRef}
                            value={inputPhrase}
                            onChange={(e) => setInputPhrase(e.target.value)}
                            placeholder="Enter the phrase or sentence to translate..."
                            rows="4"
                            className="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-colors resize-none mb-4"
                        ></textarea>
                        
                        <div className="flex justify-end">
                            <button
                                onClick={translatePhrase}
                                disabled={loading || !inputPhrase.trim()}
                                className={`px-6 py-3 rounded-lg font-bold text-white transition-all ${
                                    loading || !inputPhrase.trim()
                                        ? 'bg-blue-300 cursor-not-allowed'
                                        : 'bg-blue-500 hover:bg-blue-600 active:bg-blue-700'
                                }`}
                            >
                                {loading ? 'Translating...' : 'Translate'}
                            </button>
                        </div>
                    </div>

                    <div className="w-full max-w-2xl mt-6">
                        <h2 className="text-2xl font-bold text-gray-900 mb-4">Translation History</h2>
                        <ul className="space-y-4">
                            {translations.length > 0 ? (
                                translations.slice().reverse().map((trans) => (
                                    <li key={trans.id} className="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500 flex flex-col md:flex-row justify-between items-start md:items-center">
                                        <div className="flex-1">
                                            <p className="text-sm text-gray-500 mb-1">**Original:**</p>
                                            <p className="text-gray-900 font-semibold mb-2">{trans.original}</p>
                                            <p className="text-sm text-gray-500 mb-1">**Translation:**</p>
                                            <p className="text-blue-600 font-bold">{trans.translation}</p>
                                        </div>
                                        <button
                                            onClick={() => confirmDelete(trans.id)}
                                            className="mt-4 md:mt-0 p-2 text-red-500 hover:text-red-700 transition-colors"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
                                            </svg>
                                        </button>
                                    </li>
                                ))
                            ) : (
                                <p className="text-gray-500 text-center p-6 bg-white rounded-xl shadow-md">No translations yet. Start translating a phrase!</p>
                            )}
                        </ul>
                    </div>
                    {showModal && (
                        <Modal
                            message={modalMessage}
                            onConfirm={deleteCandidate ? handleDelete : () => setShowModal(false)}
                            onCancel={cancelDelete}
                            showConfirm={deleteCandidate !== null}
                        />
                    )}
                </div>
            );
        };

        const domNode = document.getElementById('root');
        const root = ReactDOM.createRoot(domNode);
        root.render(React.createElement(App));
    </script>
</body>
</html>
